﻿@* 1. Khai báo Model là ViewModel bạn vừa tạo *@
@model _24DH112073_MyStore.Models.ViewModel.OrderSearchVM

@* 2. Thêm thư viện PagedList để dùng cho phân trang *@
@using PagedList
@using PagedList.Mvc

@{
    ViewBag.Title = "Quản lý Đơn hàng";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml"; // Sử dụng layout Admin
}

@* Tiêu đề trang, giống trong hình *@
<h2 class="bg-success" style="padding: 10px; border-radius: 5px;">DANH SÁCH ĐƠN HÀNG</h2>

@* 3. Form Tìm Kiếm *@
@using (Html.BeginForm("Index", "Orders", FormMethod.Get, new { @class = "form-inline" }))
{
    <div class="form-group" style="margin-right: 15px;">
        @Html.LabelFor(m => m.SearchCustomerName, "Tên khách hàng", new { @style = "margin-right: 5px;" })
        @Html.TextBoxFor(m => m.SearchCustomerName, new { @class = "form-control" })
    </div>

    <div class="form-group" style="margin-right: 15px;">
        @Html.LabelFor(m => m.SearchPaymentStatus, "Trạng thái thanh toán", new { @style = "margin-right: 5px;" })
        @Html.DropDownListFor(m => m.SearchPaymentStatus,
            (IEnumerable<SelectListItem>)ViewBag.PaymentStatusList,
            new { @class = "form-control" })
    </div>

    <div class="form-group" style="margin-right: 15px;">
        @Html.LabelFor(m => m.SearchOrderDate, "Ngày đặt hàng", new { @style = "margin-right: 5px;" })
        @Html.TextBoxFor(m => m.SearchOrderDate, "{0:yyyy-MM-dd}",
            new { @class = "form-control", type = "date" })
    </div>

    <button type="submit" class="btn btn-primary">Tìm kiếm</button>
}

<hr />

@* 4. Bảng Kết Quả Danh Sách Đơn Hàng *@
<table class="table table-bordered table-striped">
    <thead style="background-color: #f5f5f5;">
        <tr>
            <th>Ngày đặt hàng</th>
            <th>Tên khách hàng</th>
            <th>Tổng giá trị</th>
            <th>Trạng thái thanh toán</th>
            <th>Phương thức giao hàng</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @if (Model.Results != null && Model.Results.Any())
        {
            foreach (var item in Model.Results)
            {
                <tr>
                    <td>@Html.DisplayFor(modelItem => item.OrderDate)</td>
                    <td>@Html.DisplayFor(modelItem => item.Customer.CustomerName)</td>
                    <td>@item.TotalAmount.ToString("N0") VNĐ</td>
                    <td>@Html.DisplayFor(modelItem => item.PaymentStatus)</td>
                    <td>@Html.DisplayFor(modelItem => item.DeliveryMethod)</td>
                    <td>
                        @Html.ActionLink("Chi tiết đơn hàng", "DetailedOrder", new { id = item.OrderID }, new { @class = "btn btn-info btn-xs" })
                    </td>
                </tr>
            }
        }
        else
        {
            <tr>
                <td colspan="6" class="text-center">
                    <strong>KHÔNG CÓ ĐƠN HÀNG NÀO PHÙ HỢP.</strong>
                </td>
            </tr>
        }
    </tbody>
</table>

@* 5. Hiển Thị Phân Trang (SỬA LỖI BẰNG JQUERY) *@
@* A. Chúng ta render PagedList ở dạng mặc định (xấu xí) *@
<div class="pagination-container text-center">
    @Html.PagedListPager(Model.Results, page => Url.Action("Index",
        new
        {
            PageNumber = page,
            searchCustomerName = Model.SearchCustomerName,
            searchPaymentStatus = Model.SearchPaymentStatus,
            searchOrderDate = Model.SearchOrderDate
        }))
</div>

@* B. Thêm Section Scripts để dùng jQuery "tân trang" lại nó *@
@section Scripts {
    <script>
        $(document).ready(function () {
            // 1. Tìm thẻ <ul> mà PagedList vừa tạo ra
            var pagerUl = $('.pagination-container ul');

            // 2. Thêm class 'pagination' của Bootstrap vào thẻ <ul>
            pagerUl.addClass('pagination');

            // 3. Thêm class 'page-item' vào mỗi thẻ <li>
            pagerUl.find('li').addClass('page-item');

            // 4. Thêm class 'page-link' vào các thẻ <a> (nút bấm)
            pagerUl.find('li a').addClass('page-link');

            // 5. Thêm class 'page-link' vào thẻ <span> (nút bị vô hiệu hóa / trang hiện tại)
            pagerUl.find('li span').addClass('page-link');
        });
    </script>
}
